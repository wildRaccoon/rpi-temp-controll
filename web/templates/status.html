<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º–∏ –æ–ø–∞–ª–µ–Ω–Ω—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
        }
        .test-mode {
            background: #ffeb3b;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .sensors {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .sensor-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
        }
        .sensor-name {
            font-weight: bold;
            color: #666;
            margin-bottom: 10px;
        }
        .temperature {
            font-size: 32px;
            font-weight: bold;
            color: #2196F3;
        }
        .outlet-status {
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            background: #e3f2fd;
        }
        .outlet-on {
            background: #c8e6c9;
        }
        .outlet-off {
            background: #ffcdd2;
        }
        .outlet-unavailable {
            background: #e0e0e0;
        }
        .status-label {
            font-weight: bold;
            margin-right: 10px;
        }
        .status-row {
            margin-top: 10px;
        }
        .connection-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .connection-ok {
            background: #4caf50;
            color: white;
        }
        .connection-error {
            background: #f44336;
            color: white;
        }
        .timestamp {
            color: #666;
            font-size: 14px;
            margin-top: 20px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
            text-align: center;
        }
        .last-update-time {
            font-weight: bold;
            color: #2196F3;
            font-family: monospace;
        }
        .system-info {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .cpu-temp {
            display: inline-block;
            font-size: 18px;
            font-weight: bold;
            color: #666;
            margin-left: 10px;
        }
        .cpu-temp.normal {
            color: #4caf50;
        }
        .cpu-temp.warm {
            color: #ff9800;
        }
        .cpu-temp.hot {
            color: #f44336;
        }
        .nav-menu {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
            padding-bottom: 10px;
        }
        .nav-item {
            padding: 10px 20px;
            text-decoration: none;
            color: #666;
            border-radius: 4px 4px 0 0;
            transition: all 0.3s;
        }
        .nav-item:hover {
            background: #e3f2fd;
            color: #2196F3;
        }
        .nav-item.active {
            background: #2196F3;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º–∏ –æ–ø–∞–ª–µ–Ω–Ω—è</h1>

        <div class="nav-menu">
            <a href="/" class="nav-item active">üìä –°—Ç–∞—Ç—É—Å</a>
            <a href="/charts.html" class="nav-item">üìà –ì—Ä–∞—Ñ—ñ–∫–∏</a>
        </div>

        {% if test_mode %}
        <div class="test-mode">‚ö†Ô∏è –¢–ï–°–¢–û–í–ò–ô –†–ï–ñ–ò–ú</div>
        {% endif %}
        
        <div id="sensors" class="sensors">
            <!-- –î–∞—Ç—á–∏–∫–∏ –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ —á–µ—Ä–µ–∑ JavaScript -->
        </div>
        
        <div id="outlet" class="outlet-status">
            <!-- –°—Ç–∞—Ç—É—Å —Ä–æ–∑–µ—Ç–∫–∏ –±—É–¥–µ –¥–æ–¥–∞–Ω–æ —á–µ—Ä–µ–∑ JavaScript -->
        </div>

        <div class="system-info">
            <span class="status-label">üñ•Ô∏è –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø—Ä–æ—Ü–µ—Å–æ—Ä–∞ Raspberry Pi:</span>
            <span class="cpu-temp" id="cpu-temp">--¬∞C</span>
        </div>

        <div class="timestamp" id="last-update">–û–Ω–æ–≤–ª–µ–Ω–Ω—è...</div>
    </div>

    <script>
        function updateStatus() {
            // –û—Ç—Ä–∏–º–∞—Ç–∏ –¥–∞–Ω—ñ —Å–∏—Å—Ç–µ–º–∏
            Promise.all([
                fetch('/api/system').then(r => r.json()),
                fetch('/api/outlet').then(r => r.json())
            ])
            .then(([systemData, outletData]) => {
                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞—Ç—á–∏–∫—ñ–≤
                updateSensors(systemData);

                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ä–æ–∑–µ—Ç–∫–∏ –∑ –¥–µ—Ç–∞–ª—å–Ω–æ—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é
                updateOutlet(systemData, outletData);

                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏ CPU
                updateCPUTemp(systemData);

                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —á–∞—Å—É –∑ —Å–µ–∫—É–Ω–¥–∞–º–∏
                const now = new Date();
                const systemTime = new Date(systemData.timestamp);
                const timeString = systemTime.toLocaleString('uk-UA', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                document.getElementById('last-update').innerHTML =
                    '–û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö: <span class="last-update-time">' + timeString + '</span>';
            })
            .catch(error => {
                console.error('–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:', error);
                document.getElementById('last-update').innerHTML =
                    '<span style="color: red;">–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º</span>';
            });
        }
        
        function updateSensors(data) {
            const sensorsDiv = document.getElementById('sensors');
            sensorsDiv.innerHTML = '';
            
            const sensors = [
                {id: 'boiler', name: '–ö–æ—Ç–µ–ª', temp: data.boiler_temp},
                {id: 'accumulator_bottom', name: '–¢–µ—Ä–º–æ–∞–∫—É–º—É–ª—è—Ç–æ—Ä (–Ω–∏–∑)', temp: data.accumulator_bottom_temp},
                {id: 'accumulator_top', name: '–¢–µ—Ä–º–æ–∞–∫—É–º—É–ª—è—Ç–æ—Ä (–≤–µ—Ä—Ö)', temp: data.accumulator_top_temp},
                {id: 'chimney', name: '–î–∏–º–∞—Ä', temp: data.chimney_temp}
            ];

            sensors.forEach(sensor => {
                const card = document.createElement('div');
                card.className = 'sensor-card';

                let tempDisplay;
                if (sensor.temp !== null && sensor.temp !== undefined) {
                    tempDisplay = `${sensor.temp.toFixed(1)}¬∞C`;
                } else {
                    tempDisplay = '<span style="color: #999;">N/A</span>';
                }

                card.innerHTML = `
                    <div class="sensor-name">${sensor.name}</div>
                    <div class="temperature">${tempDisplay}</div>
                `;
                sensorsDiv.appendChild(card);
            });
        }
        
        function updateOutlet(systemData, outletData) {
            const outletDiv = document.getElementById('outlet');
            const status = outletData.status || systemData.outlet_status;

            // –í–∏–∑–Ω–∞—á–∏—Ç–∏ –∫–ª–∞—Å CSS
            let cssClass = 'outlet-status ';
            if (status === 'unavailable') {
                cssClass += 'outlet-unavailable';
            } else if (status === 'on') {
                cssClass += 'outlet-on';
            } else {
                cssClass += 'outlet-off';
            }
            outletDiv.className = cssClass;

            // –°—Ç–∞—Ç—É—Å –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
            let connectionBadge = '';
            if (status === 'unavailable') {
                connectionBadge = '<span class="connection-status connection-error">–ù–ï –ü–Ü–î–ö–õ–Æ–ß–ï–ù–û</span>';
            } else if (outletData.connected) {
                connectionBadge = '<span class="connection-status connection-ok">–ü–Ü–î–ö–õ–Æ–ß–ï–ù–û</span>';
            } else {
                connectionBadge = '<span class="connection-status connection-error">–ü–û–ú–ò–õ–ö–ê –ó–í\'–Ø–ó–ö–£</span>';
            }

            // –¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å—É
            let statusText = '';
            if (status === 'unavailable') {
                statusText = '–ù–ï –ù–ê–õ–ê–®–¢–û–í–ê–ù–û';
            } else if (status === 'on') {
                statusText = '–£–í–Ü–ú–ö–ù–ï–ù–û';
            } else {
                statusText = '–í–ò–ú–ö–ù–ï–ù–û';
            }

            // –§–æ—Ä–º—É–≤–∞–Ω–Ω—è HTML
            let html = `
                <div>
                    <span class="status-label">–†–æ–∑–µ—Ç–∫–∞ (—Ü–∏—Ä–∫—É–ª—è—Ü—ñ–π–Ω–∏–π –Ω–∞—Å–æ—Å):</span>
                    <span style="font-size: 24px; font-weight: bold;">${statusText}</span>
                    ${connectionBadge}
                </div>
            `;

            // IP –∞–¥—Ä–µ—Å–∞ (—è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω–∞)
            if (outletData.ip_address) {
                html += `
                    <div class="status-row">
                        <span class="status-label">IP –∞–¥—Ä–µ—Å–∞:</span>
                        <span style="font-family: monospace;">${outletData.ip_address}</span>
                    </div>
                `;
            }

            // –û—Å—Ç–∞–Ω–Ω—î –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥ —Ä–æ–∑–µ—Ç–∫–∏
            if (outletData.last_update) {
                const outletTime = new Date(outletData.last_update);
                const outletTimeStr = outletTime.toLocaleString('uk-UA', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                html += `
                    <div class="status-row">
                        <span class="status-label">–û—Å—Ç–∞–Ω–Ω—ñ–π –∑–≤'—è–∑–æ–∫ –∑ —Ä–æ–∑–µ—Ç–∫–æ—é:</span>
                        <span style="font-family: monospace;">${outletTimeStr}</span>
                    </div>
                `;
            }

            // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (–¥–ª—è unavailable —Å—Ç–∞—Ç—É—Å—É)
            if (outletData.message) {
                html += `
                    <div class="status-row">
                        <span style="color: #666; font-style: italic;">${outletData.message}</span>
                    </div>
                `;
            }

            // –ü—Ä–∏—á–∏–Ω–∞ –∑–º—ñ–Ω–∏ —Å—Ç–∞–Ω—É
            if (systemData.outlet_reason || outletData.reason) {
                const reason = systemData.outlet_reason || outletData.reason;
                html += `
                    <div class="status-row">
                        <span class="status-label">–ü—Ä–∏—á–∏–Ω–∞:</span>
                        <span>${reason}</span>
                    </div>
                `;
            }

            // –°—Ç–∞–Ω —Å–∏—Å—Ç–µ–º–∏
            html += `
                <div class="status-row">
                    <span class="status-label">–°—Ç–∞–Ω —Å–∏—Å—Ç–µ–º–∏:</span>
                    <span>${systemData.state}</span>
                </div>
            `;

            outletDiv.innerHTML = html;
        }

        function updateCPUTemp(data) {
            const cpuTempElement = document.getElementById('cpu-temp');

            if (data.cpu_temp !== undefined && data.cpu_temp !== null) {
                const temp = data.cpu_temp;
                cpuTempElement.textContent = temp.toFixed(1) + '¬∞C';

                // –í–∏–∑–Ω–∞—á–∏—Ç–∏ –∫–æ–ª—ñ—Ä –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∏
                cpuTempElement.className = 'cpu-temp';
                if (temp < 60) {
                    cpuTempElement.classList.add('normal');
                } else if (temp < 75) {
                    cpuTempElement.classList.add('warm');
                } else {
                    cpuTempElement.classList.add('hot');
                }
            } else {
                cpuTempElement.textContent = 'N/A';
                cpuTempElement.className = 'cpu-temp';
            }
        }

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 10 —Å–µ–∫—É–Ω–¥
        updateStatus();
        setInterval(updateStatus, 10000);
    </script>
</body>
</html>

