# Система контролю температури для твердопаливного котла

Програма для Raspberry Pi, яка контролює систему опалення з твердопаливним котлом та термоакумулятором. Зчитує температури з кількох датчиків та автоматично керує розумною розеткою (Tapo) для включення теплого підлоги з метою безпеки та ефективного використання тепла.

## 📋 Функціонал

- Зчитування температури з 4 датчиків (3x DS18B20 + 1x MAX31855)
- Автоматичне керування розеткою Tapo (теплий підлога)
- Збереження даних у локальну базу даних SQLite
- REST API для моніторингу
- Веб-інтерфейс з графіками
- Тестовий режим для розробки без обладнання

## 🚀 Швидкий старт

### 1. Налаштування віртуального середовища Python

**На Linux/Mac:**
```bash
# Створення віртуального середовища
python3 -m venv venv

# Активація віртуального середовища
source venv/bin/activate

# Встановлення залежностей
pip install --upgrade pip
pip install -r requirements.txt
```

**На Windows:**
```bash
# Створення віртуального середовища
python -m venv venv

# Активація віртуального середовища
venv\Scripts\activate

# Встановлення залежностей
python -m pip install --upgrade pip
pip install -r requirements.txt
```

### 2. Налаштування конфігурації

Скопіюйте приклад конфігурації та налаштуйте під своє обладнання:

```bash
cp config.example.yaml config.yaml
# Відредагуйте config.yaml зі своїми налаштуваннями
```

### 3. Запуск програми

**Тестовий режим (без реального обладнання):**
```bash
python main.py --test-mode --scenario normal
```

**Production режим:**
```bash
python main.py
```

**Як systemd сервіс:**
```bash
sudo cp tapo-temperature.service /etc/systemd/system/
sudo systemctl enable tapo-temperature.service
sudo systemctl start tapo-temperature.service
```

## 📁 Структура проекту

```
tapo/
├── main.py                 # Головний файл програми
├── config.yaml            # Файл конфігурації
├── requirements.txt       # Залежності Python
├── sensors/               # Модулі датчиків
├── controllers/           # Контролери (Tapo, температура)
├── database/              # Робота з базою даних
├── api/                   # REST API сервер
├── web/                   # Веб-інтерфейс (HTML, CSS, JS)
├── tests/                 # Тестові модулі
├── utils/                 # Утиліти
├── logs/                  # Логи
└── data/                  # База даних
```

## 🔧 Налаштування Raspberry Pi

### Програмне налаштування

1. Увімкніть 1-Wire інтерфейс для DS18B20:
   ```bash
   sudo raspi-config
   # Interface Options → 1-Wire → Enable
   ```

2. Увімкніть SPI для MAX31855:
   ```bash
   sudo raspi-config
   # Interface Options → SPI → Enable
   ```

3. Додайте користувача до груп:
   ```bash
   sudo usermod -a -G gpio,spi $USER
   ```

4. Перезавантажте Raspberry Pi:
   ```bash
   sudo reboot
   ```

### Апаратне підключення датчиків

#### Підключення DS18B20 датчиків (1-Wire шина)

**Важливо:** Всі 3 датчика DS18B20 підключені до **однієї 1-Wire шини** (один GPIO пін).

**Схема підключення:**

```
Raspberry Pi GPIO:
┌─────────────────────────────────────┐
│  Pin 1 (3.3V)  ────┐                │
│  Pin 6 (GND)   ────┼───┐            │
│  Pin 7 (GPIO 4)────┼───┼─── DATA     │
└────────────────────┼───┼────────────┘
                     │   │
                  [4.7kΩ]│
                     │   │
                     └───┘
                        │
        ┌───────────────┼───────────────┐
        │               │               │
    DS18B20 #1      DS18B20 #2      DS18B20 #3
    (Котел)      (Термоак. низ)  (Термоак. верх)
        │               │               │
    ┌───┴───┐       ┌───┴───┐       ┌───┴───┐
    │ VCC   │       │ VCC   │       │ VCC   │
    │ DATA  │       │ DATA  │       │ DATA  │
    │ GND   │       │ GND   │       │ GND   │
    └───────┘       └───────┘       └───────┘
```

**Підключення кожного DS18B20:**
- **VCC (червоний)** → Pin 1 (3.3V) на Raspberry Pi
- **DATA (жовтий/білий)** → Pin 7 (GPIO 4) на Raspberry Pi
- **GND (чорний)** → Pin 6 (GND) на Raspberry Pi
- **Підтягуючий резистор 4.7 кОм** між DATA та VCC (можна один на всю шину)

**GPIO піни Raspberry Pi:**
- **GPIO 4** (фізичний пін 7) - стандартний пін для 1-Wire
- Всі датчики підключені паралельно до цього піна
- Кожен датчик має унікальний 64-бітний ID для розрізнення

**Визначення ID датчиків:**

Після підключення та увімкнення 1-Wire, ID датчиків можна знайти:

```bash
# Перевірити доступні датчики
ls /sys/bus/w1/devices/

# Ви побачите щось на кшталт:
# 28-00000abc1234
# 28-00000def5678
# 28-00000ghi9012

# Перевірити температуру конкретного датчика
cat /sys/bus/w1/devices/28-00000abc1234/w1_slave
```

**Примітка:** ID датчиків потрібно вказати в `config.yaml` для кожного датчика.

#### Підключення MAX31855 (SPI термопара)

**Схема підключення:**

```
Raspberry Pi SPI:
┌─────────────────────────────────────┐
│  Pin 1 (3.3V)  ──── VCC             │
│  Pin 6 (GND)   ──── GND             │
│  Pin 19 (MOSI) ──── DIN             │
│  Pin 21 (MISO) ──── DO              │
│  Pin 23 (SCLK) ──── CLK             │
│  Pin 24 (CE0)   ──── CS (або інший GPIO) │
└─────────────────────────────────────┘
              │
         MAX31855
         ┌─────────┐
         │ VCC     │
         │ GND     │
         │ DIN     │
         │ DO      │
         │ CLK     │
         │ CS      │
         │ T+      │─── Термопара (+)
         │ T-      │─── Термопара (-)
         └─────────┘
```

**Підключення MAX31855:**
- **VCC** → Pin 1 (3.3V) або Pin 2 (5V) на Raspberry Pi
- **GND** → Pin 6 (GND) на Raspberry Pi
- **DIN (MOSI)** → Pin 19 (GPIO 10, MOSI) на Raspberry Pi
- **DO (MISO)** → Pin 21 (GPIO 9, MISO) на Raspberry Pi
- **CLK (SCLK)** → Pin 23 (GPIO 11, SCLK) на Raspberry Pi
- **CS (Chip Select)** → Pin 24 (GPIO 8, CE0) або будь-який інший GPIO пін (вказати в config.yaml як `cs_pin`)

**Термопара типу K:**
- **T+ (червоний)** → підключити до T+ на MAX31855
- **T- (жовтий)** → підключити до T- на MAX31855

**Налаштування в config.yaml:**
```yaml
max31855:
  chimney:
    cs_pin: 8        # GPIO пін для CS (за замовчуванням 8)
    spi_port: 0      # SPI порт (0 або 1)
    spi_device: 0    # SPI пристрій (зазвичай 0)
```

#### Таблиця підключення (Raspberry Pi GPIO)

| Компонент | Пін Raspberry Pi | Призначення |
|-----------|------------------|-------------|
| DS18B20 (всі 3) | Pin 7 (GPIO 4) | 1-Wire DATA |
| DS18B20 (всі 3) | Pin 1 | 3.3V (VCC) |
| DS18B20 (всі 3) | Pin 6 | GND |
| MAX31855 | Pin 19 (GPIO 10) | MOSI (DIN) |
| MAX31855 | Pin 21 (GPIO 9) | MISO (DO) |
| MAX31855 | Pin 23 (GPIO 11) | SCLK (CLK) |
| MAX31855 | Pin 24 (GPIO 8) | CS (або інший GPIO) |
| MAX31855 | Pin 1 | 3.3V (VCC) |
| MAX31855 | Pin 6 | GND |

#### Важливі примітки

1. **1-Wire шина:**
   - Всі DS18B20 датчики підключені до одного GPIO піна (GPIO 4)
   - Кожен датчик має унікальний ID, який використовується для розрізнення
   - Потрібен один підтягуючий резистор 4.7 кОм на всю шину

2. **Визначення ID датчиків:**
   - Після підключення запустіть програму без `device_id` в конфігурації
   - Програма автоматично знайде всі доступні датчики та виведе їх ID
   - Скопіюйте ID та вкажіть в `config.yaml` для кожного датчика

3. **Перевірка підключення:**
   ```bash
   # Перевірити 1-Wire датчики
   ls /sys/bus/w1/devices/
   
   # Перевірити SPI
   ls /dev/spi*
   ```

4. **Безпека:**
   - Перевірте полярність перед підключенням
   - Використовуйте стабільне живлення 3.3V
   - Переконайтеся, що GND підключений правильно

## 🌐 Веб-інтерфейс

Після запуску програми веб-інтерфейс буде доступний за адресою:

- **Статус**: `http://raspberry-pi-ip:8080/status.html`
- **Графіки**: `http://raspberry-pi-ip:8080/charts.html`
- **API**: `http://raspberry-pi-ip:8080/api/status`

## 🧪 Тестовий режим

Для тестування без реального обладнання:

```bash
# Нормальна робота
python main.py --test-mode --scenario normal

# Критичні температури
python main.py --test-mode --scenario critical

# Затухання
python main.py --test-mode --scenario cooling

# Початковий стан
python main.py --test-mode --scenario startup
```

## 📝 Документація

- [PLAN.md](PLAN.md) - детальний план проекту
- [INSTALL.md](INSTALL.md) - детальна інструкція по встановленню на Raspberry Pi

## 🧪 Тестування

### Швидкий тест

Запустіть програму в тестовому режимі в одному терміналі:
```bash
python main.py --test-mode --scenario normal
```

В іншому терміналі запустіть тест:
```bash
python tests/test_run.py
```

### Тест всіх сценаріїв

```bash
python tests/test_scenarios.py
```

Це послідовно запустить всі тестові сценарії та перевірить правильність логіки.

## ⚙️ Конфігурація

Основні параметри конфігурації в `config.yaml`:

- `sensors` - налаштування датчиків
- `tapo` - налаштування розетки Tapo
- `control` - порогові температури та логіка контролю
- `database` - налаштування бази даних
- `api` - налаштування веб-сервера
- `test_mode` - налаштування тестового режиму

## 🛠️ Розробка

1. Створіть віртуальне середовище (див. вище)
2. Встановіть залежності: `pip install -r requirements.txt`
3. Запустіть в тестовому режимі: `python main.py --test-mode`
4. Відкрийте веб-інтерфейс: `http://localhost:8080/status.html`

## 📄 Ліцензія

[Вкажіть ліцензію]

## 👤 Автор

[Ваше ім'я]

